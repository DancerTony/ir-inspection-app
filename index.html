<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>赤外線写真建築物検査アプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#ff6b35" />
  <style>
    :root {
      --bg: #0b0c10;
      --bg-alt: #111319;
      --accent: #ff6b35;
      --accent-soft: rgba(255, 107, 53, 0.18);
      --accent-strong: #ff3b00;
      --text: #f5f5f5;
      --muted: #a0a4b8;
      --border: #262a36;
      --danger: #ff3366;
      --ok: #3ddc97;
      --warn: #ffb703;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #1b1f2f 0, #05060a 55%, #000 100%);
      color: var(--text);
    }

    .app-shell {
      display: grid;
      grid-template-columns: 320px minmax(0, 1.6fr) minmax(0, 1.2fr);
      gap: 16px;
      padding: 16px;
      min-height: 100vh;
    }

    @media (max-width: 1100px) {
      .app-shell {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: linear-gradient(145deg, rgba(255,255,255,0.02), rgba(0,0,0,0.7));
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 14px 16px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.6);
      backdrop-filter: blur(14px);
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .panel-title {
      font-size: 14px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      border: 1px solid var(--accent);
      color: var(--accent);
      background: rgba(255, 107, 53, 0.08);
    }

    h1 {
      margin: 0 0 4px;
      font-size: 20px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    h1 span.logo-mark {
      width: 22px;
      height: 22px;
      border-radius: 6px;
      background: conic-gradient(from 210deg, #ff6b35, #ffb703, #ff3366, #ff6b35);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #050505;
      font-weight: 900;
      font-size: 13px;
      box-shadow: 0 0 18px rgba(255, 107, 53, 0.7);
    }

    .subtitle {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.16em;
      margin-bottom: 10px;
    }

    label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      display: block;
      margin-bottom: 4px;
    }

    input[type="text"],
    input[type="date"],
    input[type="time"],
    select,
    textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(5, 6, 10, 0.9);
      color: var(--text);
      padding: 7px 9px;
      font-size: 13px;
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    input[type="time"]:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(255, 107, 53, 0.4);
      background: rgba(5, 6, 10, 0.98);
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .field-group {
      margin-bottom: 10px;
    }

    .field-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .chip {
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 11px;
      border: 1px solid var(--border);
      color: var(--muted);
      cursor: pointer;
      background: rgba(10, 12, 18, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: all 0.15s ease;
    }

    .chip span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .chip.active {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-soft);
    }

    .file-input {
      border: 1px dashed var(--border);
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
      background: rgba(5, 6, 10, 0.9);
      transition: border 0.15s ease, background 0.15s ease;
    }

    .file-input:hover {
      border-color: var(--accent);
      background: rgba(10, 12, 18, 0.95);
    }

    .file-input input {
      display: none;
    }

    .file-input span {
      display: block;
      margin-top: 4px;
      font-size: 11px;
      color: var(--muted);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    button {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 6px 12px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(255, 255, 255, 0.02);
      color: var(--muted);
      transition: all 0.15s ease;
    }

    button.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #050505;
      border-color: rgba(0,0,0,0.6);
      box-shadow: 0 10px 22px rgba(255, 107, 53, 0.45);
    }

    button.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(255, 107, 53, 0.6);
    }

    button.outline {
      border-color: var(--border);
      color: var(--muted);
      background: rgba(5, 6, 10, 0.9);
    }

    button.outline:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(10, 12, 18, 0.95);
    }

    button.danger {
      border-color: rgba(255, 51, 102, 0.7);
      color: var(--danger);
      background: rgba(255, 51, 102, 0.08);
    }

    button.small {
      padding: 4px 9px;
      font-size: 10px;
    }

    button:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .canvas-wrapper {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: radial-gradient(circle at top, #2b2f3f 0, #05060a 60%);
      min-height: 260px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    canvas {
      max-width: 100%;
      height: auto;
      display: block;
      cursor: crosshair;
    }

    .canvas-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at top, rgba(255, 107, 53, 0.08), transparent 55%);
      mix-blend-mode: screen;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      font-size: 10px;
      color: var(--muted);
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .legend-swatch {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    .legend-swatch.critical { background: var(--danger); }
    .legend-swatch.warning { background: var(--warn); }
    .legend-swatch.info { background: var(--ok); }

    .defect-list {
      margin-top: 8px;
      max-height: 180px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .defect-card {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 7px 8px;
      margin-bottom: 6px;
      background: rgba(5, 6, 10, 0.9);
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 6px;
      align-items: center;
    }

    .defect-number {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fff, #ff6b35);
      color: #050505;
      font-size: 12px;
      font-weight: 800;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 10px rgba(255, 107, 53, 0.7);
    }

    .defect-meta {
      font-size: 11px;
      color: var(--muted);
    }

    .defect-meta strong {
      color: var(--text);
      font-weight: 500;
    }

    .defect-tag {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .defect-tag.critical {
      border-color: rgba(255, 51, 102, 0.7);
      color: var(--danger);
      background: rgba(255, 51, 102, 0.08);
    }

    .defect-tag.warning {
      border-color: rgba(255, 183, 3, 0.7);
      color: var(--warn);
      background: rgba(255, 183, 3, 0.08);
    }

    .defect-tag.info {
      border-color: rgba(61, 220, 151, 0.7);
      color: var(--ok);
      background: rgba(61, 220, 151, 0.08);
    }

    .report-body {
      font-size: 12px;
      line-height: 1.6;
      background: rgba(5, 6, 10, 0.9);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 10px;
      max-height: 320px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    .report-header span.label {
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .report-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 8px;
    }

    .pill {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .divider {
      height: 1px;
      background: linear-gradient(to right, transparent, var(--border), transparent);
      margin: 8px 0;
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    .status-row strong {
      color: var(--text);
      font-weight: 500;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--ok);
      box-shadow: 0 0 10px rgba(61, 220, 151, 0.7);
    }

    .status-dot.warn {
      background: var(--warn);
      box-shadow: 0 0 10px rgba(255, 183, 3, 0.7);
    }

    .status-dot.bad {
      background: var(--danger);
      box-shadow: 0 0 10px rgba(255, 51, 102, 0.7);
    }

    .hint {
      font-size: 10px;
      color: var(--muted);
      margin-top: 4px;
    }

    .hint strong {
      color: var(--accent);
      font-weight: 500;
    }

    /* print */
    @media print {
      body {
        background: #fff;
        color: #000;
      }
      .app-shell {
        display: block;
        padding: 0;
      }
      .panel {
        box-shadow: none;
        border-radius: 0;
        border: none;
        padding: 0;
      }
      #non-print {
        display: none !important;
      }
      #report-panel {
        border: none;
      }
      .report-body {
        max-height: none;
        overflow: visible;
        background: #fff;
        border: none;
        padding: 0;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- 左：入力パネル -->
    <section class="panel" id="non-print">
      <div class="panel-header">
        <div>
          <h1><span class="logo-mark">IR</span>赤外線写真建築物検査</h1>
          <div class="subtitle">Infrared Building Inspection – Wild & Modern</div>
        </div>
        <span class="badge">Single Page App</span>
      </div>

      <div class="field-group">
        <label>案件情報 / Project</label>
        <input type="text" id="projectName" placeholder="例：〇〇ビル 外壁診断 2026-01" />
      </div>

      <div class="field-row field-group">
        <div>
          <label>検査日</label>
          <input type="date" id="inspectDate" />
        </div>
        <div>
          <label>検査時間帯</label>
          <input type="time" id="inspectTime" />
        </div>
      </div>

      <div class="field-row field-group">
        <div>
          <label>構造 / RC工法</label>
          <select id="structure">
            <option value="">選択してください</option>
            <option value="RC">RC（鉄筋コンクリート）</option>
            <option value="SRC">SRC（鉄骨鉄筋コンクリート）</option>
            <option value="S">S（鉄骨造）</option>
            <option value="W">W（木造）</option>
            <option value="Other">その他</option>
          </select>
        </div>
        <div>
          <label>対象</label>
          <select id="targetType">
            <option value="">選択してください</option>
            <option value="Building">建物全体</option>
            <option value="Facade">外壁</option>
            <option value="Roof">屋上・屋根</option>
            <option value="Solar">太陽光パネル</option>
            <option value="Detail">部分ディテール</option>
          </select>
        </div>
      </div>

      <div class="field-group">
        <label>天候 / Weather</label>
        <div class="chip-row" id="weatherChips">
          <div class="chip" data-value="晴れ"><span class="dot"></span>晴れ</div>
          <div class="chip" data-value="曇り"><span class="dot"></span>曇り</div>
          <div class="chip" data-value="雨"><span class="dot"></span>雨</div>
          <div class="chip" data-value="強風">強風</div>
          <div class="chip" data-value="その他">その他</div>
        </div>
        <input type="text" id="weatherDetail" placeholder="詳細（例：前日雨、外気温5℃、西日あり 等）" style="margin-top:6px;" />
      </div>

      <div class="field-group">
        <label>撮影条件 / Shooting Conditions</label>
        <textarea id="shootingCondition" placeholder="例：撮影距離15m、角度30°、夜間撮影、外壁タイル面 等"></textarea>
      </div>

      <div class="field-group">
        <label>赤外線写真アップロード</label>
        <div class="file-input" id="fileDrop">
          <div>画像ファイルを選択 / ドラッグ＆ドロップ</div>
          <span id="fileName">未選択</span>
          <input type="file" id="imageInput" accept="image/*" />
        </div>
      </div>

      <div class="btn-row">
        <button class="primary" id="generateReportBtn">レポート自動生成</button>
        <button class="outline small" id="clearDefectsBtn">不具合ポイントをリセット</button>
      </div>

      <div class="hint">
        <strong>ヒント：</strong>入力内容はすべてブラウザ内で処理されます。リロードすると内容は消去されます。
      </div>
    </section>

    <!-- 中央：画像＆不具合マーキング -->
    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <span>Infrared Image</span>
        </div>
        <span class="pill">
          <span class="pill-dot"></span> Click to mark defects
        </span>
      </div>

      <div class="canvas-wrapper">
        <canvas id="photoCanvas"></canvas>
        <div class="canvas-overlay"></div>
      </div>

      <div class="legend">
        <div class="legend-item">
          <span class="legend-swatch critical"></span> 重大不具合
        </div>
        <div class="legend-item">
          <span class="legend-swatch warning"></span> 要注意
        </div>
        <div class="legend-item">
          <span class="legend-swatch info"></span> 経過観察
        </div>
      </div>

      <div class="divider"></div>

      <div class="field-row">
        <div class="field-group">
          <label>選択中の重要度</label>
          <div class="chip-row" id="severityChips">
            <div class="chip active" data-value="critical"><span class="dot"></span>重大</div>
            <div class="chip" data-value="warning"><span class="dot"></span>注意</div>
            <div class="chip" data-value="info"><span class="dot"></span>観察</div>
          </div>
        </div>
        <div class="field-group">
          <label>不具合テンプレート</label>
          <select id="defectTemplate">
            <option value="">選択すると説明に挿入</option>
            <option value="タイル浮き・剥離の疑い">タイル浮き・剥離の疑い</option>
            <option value="雨水浸入の可能性">雨水浸入の可能性</option>
            <option value="断熱不良・熱橋の可能性">断熱不良・熱橋の可能性</option>
            <option value="漏水・配管周りの異常">漏水・配管周りの異常</option>
            <option value="太陽光パネルのセル異常">太陽光パネルのセル異常</option>
          </select>
        </div>
      </div>

      <div class="field-group">
        <label>最新の不具合説明</label>
        <textarea id="defectDescription" placeholder="キャンバス上をクリックして不具合ポイントを追加します。ここに説明を入力し、「説明を更新」で保存します。"></textarea>
        <div class="btn-row">
          <button class="outline small" id="applyTemplateBtn">テンプレートを説明に挿入</button>
          <button class="primary small" id="updateDefectBtn">説明を更新</button>
        </div>
      </div>

      <div class="status-row">
        <div>不具合ポイント数：<strong id="defectCount">0</strong></div>
        <div style="display:flex;align-items:center;gap:6px;">
          <span class="status-dot" id="statusDot"></span>
          <span id="statusText">診断準備中</span>
        </div>
      </div>
    </section>

    <!-- 右：不具合一覧＆レポート -->
    <section class="panel" id="report-panel">
      <div class="panel-header">
        <div class="panel-title">
          <span>Defect List & Report</span>
        </div>
        <span class="badge">Report Mode</span>
      </div>

      <div class="field-group">
        <label>不具合一覧</label>
        <div class="defect-list" id="defectList"></div>
      </div>

      <div class="divider"></div>

      <div class="report-header">
        <span class="label">診断結果レポート</span>
        <span id="reportMeta">未生成</span>
      </div>

      <div class="report-body" id="reportBody">
        レポートを生成するとここに内容が表示されます。
      </div>

      <div class="report-actions" id="non-print">
        <button class="outline small" id="copyReportBtn">テキストをコピー</button>
        <button class="primary small" id="printReportBtn">印刷 / PDF出力</button>
      </div>
    </section>
  </div>

  <script>
    const imageInput = document.getElementById('imageInput');
    const fileDrop = document.getElementById('fileDrop');
    const fileName = document.getElementById('fileName');
    const canvas = document.getElementById('photoCanvas');
    const ctx = canvas.getContext('2d');
    const defectListEl = document.getElementById('defectList');
    const defectDescriptionEl = document.getElementById('defectDescription');
    const defectCountEl = document.getElementById('defectCount');
    const statusDotEl = document.getElementById('statusDot');
    const statusTextEl = document.getElementById('statusText');
    const reportBodyEl = document.getElementById('reportBody');
    const reportMetaEl = document.getElementById('reportMeta');

    let image = null;
    let defects = [];
    let selectedDefectId = null;
    let currentSeverity = 'critical';

    function setStatus() {
      const count = defects.length;
      defectCountEl.textContent = count;
      if (count === 0) {
        statusDotEl.className = 'status-dot';
        statusTextEl.textContent = '診断準備中';
      } else if (defects.some(d => d.severity === 'critical')) {
        statusDotEl.className = 'status-dot bad';
        statusTextEl.textContent = '重大な不具合の疑いあり';
      } else if (defects.some(d => d.severity === 'warning')) {
        statusDotEl.className = 'status-dot warn';
        statusTextEl.textContent = '注意すべき不具合あり';
      } else {
        statusDotEl.className = 'status-dot';
        statusTextEl.textContent = '経過観察レベルの不具合のみ';
      }
    }

    function drawImageAndMarkers() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (image) {
        const maxWidth = canvas.parentElement.clientWidth - 20;
        const scale = Math.min(maxWidth / image.width, 1);
        canvas.width = image.width * scale;
        canvas.height = image.height * scale;
        ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
      } else {
        canvas.width = 480;
        canvas.height = 260;
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop(0, '#ff6b35');
        gradient.addColorStop(0.4, '#ffb703');
        gradient.addColorStop(0.7, '#6a4c93');
        gradient.addColorStop(1, '#111827');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'rgba(0,0,0,0.4)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'rgba(255,255,255,0.8)';
        ctx.font = '12px system-ui';
        ctx.textAlign = 'center';
        ctx.fillText('赤外線写真をアップロードし、', canvas.width / 2, canvas.height / 2 - 8);
        ctx.fillText('キャンバス上をクリックして不具合ポイントを追加します。', canvas.width / 2, canvas.height / 2 + 10);
      }

      defects.forEach(defect => {
        const { x, y, severity, id } = defect;
        let color;
        if (severity === 'critical') color = '#ff3366';
        else if (severity === 'warning') color = '#ffb703';
        else color = '#3ddc97';

        ctx.beginPath();
        ctx.arc(x, y, 10, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(0,0,0,0.6)';
        ctx.fill();

        ctx.beginPath();
        ctx.arc(x, y, 9, 0, Math.PI * 2);
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.stroke();

        ctx.fillStyle = color;
        ctx.font = 'bold 11px system-ui';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(id, x, y);
      });
    }

    function renderDefectList() {
      defectListEl.innerHTML = '';
      if (defects.length === 0) {
        defectListEl.innerHTML = '<div class="hint">不具合ポイントはまだ登録されていません。キャンバス上をクリックして追加してください。</div>';
        return;
      }

      defects.forEach(defect => {
        const card = document.createElement('div');
        card.className = 'defect-card';
        card.dataset.id = defect.id;

        const num = document.createElement('div');
        num.className = 'defect-number';
        num.textContent = defect.id;

        const meta = document.createElement('div');
        meta.className = 'defect-meta';
        meta.innerHTML = `
          <strong>${defect.title || '不具合ポイント ' + defect.id}</strong><br>
          位置：x=${Math.round(defect.x)}, y=${Math.round(defect.y)}<br>
          説明：${defect.description || '（説明未入力）'}
        `;

        const tag = document.createElement('div');
        tag.className = 'defect-tag ' + defect.severity;
        tag.textContent =
          defect.severity === 'critical' ? '重大' :
          defect.severity === 'warning' ? '注意' : '観察';

        card.appendChild(num);
        card.appendChild(meta);
        card.appendChild(tag);

        card.addEventListener('click', () => {
          selectedDefectId = defect.id;
          defectDescriptionEl.value = defect.description || '';
          document.querySelectorAll('.defect-card').forEach(c => c.style.borderColor = 'var(--border)');
          card.style.borderColor = 'var(--accent)';
        });

        defectListEl.appendChild(card);
      });
    }

    function addDefect(x, y) {
      const id = defects.length + 1;
      const defect = {
        id,
        x,
        y,
        severity: currentSeverity,
        title: '',
        description: ''
      };
      defects.push(defect);
      selectedDefectId = id;
      renderDefectList();
      drawImageAndMarkers();
      setStatus();
      defectDescriptionEl.value = '';
    }

    canvas.addEventListener('click', (e) => {
      if (!image) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      addDefect(x, y);
    });

    function handleFile(file) {
      if (!file) return;
      fileName.textContent = file.name;
      const reader = new FileReader();
      reader.onload = function (e) {
        image = new Image();
        image.onload = function () {
          drawImageAndMarkers();
        };
        image.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    imageInput.addEventListener('change', (e) => {
      handleFile(e.target.files[0]);
    });

    fileDrop.addEventListener('click', () => imageInput.click());

    fileDrop.addEventListener('dragover', (e) => {
      e.preventDefault();
      fileDrop.style.borderColor = 'var(--accent)';
    });

    fileDrop.addEventListener('dragleave', (e) => {
      e.preventDefault();
      fileDrop.style.borderColor = 'var(--border)';
    });

    fileDrop.addEventListener('drop', (e) => {
      e.preventDefault();
      fileDrop.style.borderColor = 'var(--border)';
      const file = e.dataTransfer.files[0];
      handleFile(file);
    });

    function setupChipGroup(containerId, callback) {
      const container = document.getElementById(containerId);
      container.addEventListener('click', (e) => {
        const chip = e.target.closest('.chip');
        if (!chip) return;
        container.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        if (callback) callback(chip.dataset.value);
      });
    }

    setupChipGroup('weatherChips', (value) => {
      const detail = document.getElementById('weatherDetail');
      if (!detail.value) detail.value = value;
    });

    setupChipGroup('severityChips', (value) => {
      currentSeverity = value;
    });

    document.getElementById('applyTemplateBtn').addEventListener('click', () => {
      const template = document.getElementById('defectTemplate').value;
      if (!template) return;
      const current = defectDescriptionEl.value;
      defectDescriptionEl.value = current ? current + '\n' + template : template;
    });

    document.getElementById('updateDefectBtn').addEventListener('click', () => {
      if (!selectedDefectId) {
        alert('先にキャンバス上をクリックして不具合ポイントを追加してください。');
        return;
      }
      const defect = defects.find(d => d.id === selectedDefectId);
      if (!defect) return;
      defect.description = defectDescriptionEl.value.trim();
      if (!defect.title && defect.description) {
        defect.title = defect.description.split('\n')[0].slice(0, 30);
      }
      renderDefectList();
    });

    document.getElementById('clearDefectsBtn').addEventListener('click', () => {
      if (!confirm('すべての不具合ポイントを削除しますか？')) return;
      defects = [];
      selectedDefectId = null;
      defectDescriptionEl.value = '';
      renderDefectList();
      drawImageAndMarkers();
      setStatus();
    });

    function generateReport() {
      const projectName = document.getElementById('projectName').value || '（案件名未入力）';
      const inspectDate = document.getElementById('inspectDate').value || '（未入力）';
      const inspectTime = document.getElementById('inspectTime').value || '（未入力）';
      const structure = document.getElementById('structure').value || '（未選択）';
      const targetType = document.getElementById('targetType').value || '（未選択）';
      const weatherDetail = document.getElementById('weatherDetail').value || '（未入力）';
      const shootingCondition = document.getElementById('shootingCondition').value || '（未入力）';

      let summary = '';
      const criticalCount = defects.filter(d => d.severity === 'critical').length;
      const warningCount = defects.filter(d => d.severity === 'warning').length;
      const infoCount = defects.filter(d => d.severity === 'info').length;

      if (defects.length === 0) {
        summary = '今回の赤外線画像から顕著な異常は確認されませんでした。ただし、定期的なモニタリングを推奨します。';
      } else {
        summary += `今回の赤外線診断では、合計 ${defects.length} 箇所の温度異常が確認されました。\n`;
        if (criticalCount > 0) summary += `・重大な不具合の疑い：${criticalCount} 箇所\n`;
        if (warningCount > 0) summary += `・注意を要する箇所：${warningCount} 箇所\n`;
        if (infoCount > 0) summary += `・経過観察レベル：${infoCount} 箇所\n`;
        summary += '\nこれらの結果から、早期の詳細調査および補修計画の検討を推奨します。';
      }

      let defectDetails = '';
      if (defects.length > 0) {
        defectDetails += '【不具合ポイント一覧】\n';
        defects.forEach(d => {
          const sev =
            d.severity === 'critical' ? '重大' :
            d.severity === 'warning' ? '注意' : '観察';
          defectDetails += `\nNo.${d.id}（重要度：${sev}）\n`;
          defectDetails += `・位置：キャンバス座標 x=${Math.round(d.x)}, y=${Math.round(d.y)}\n`;
          defectDetails += `・内容：${d.description || '（説明未入力）'}\n`;
        });
      } else {
        defectDetails += '今回の画像では、明確な不具合ポイントはマーキングされていません。';
      }

      const reportText =
`【案件情報】
・案件名：${projectName}
・検査日：${inspectDate}
・検査時間帯：${inspectTime}
・構造種別：${structure}
・対象：${targetType}

【環境条件】
・天候・外気条件：${weatherDetail}
・撮影条件：${shootingCondition}

【総合所見】
${summary}

${defectDetails}

【総括コメント】
本レポートは、赤外線画像に基づく一次診断結果です。実際の補修計画や安全性評価にあたっては、打診調査・コア抜き・目視確認等の詳細調査を併用し、総合的な判断を行ってください。`;

      reportBodyEl.textContent = reportText;
      const now = new Date();
      reportMetaEl.textContent = `自動生成：${now.toLocaleString('ja-JP')}`;
    }

    document.getElementById('generateReportBtn').addEventListener('click', generateReport);

    document.getElementById('copyReportBtn').addEventListener('click', () => {
      const text = reportBodyEl.textContent;
      if (!text || text.trim() === '') return;
      navigator.clipboard.writeText(text).then(() => {
        alert('レポートテキストをコピーしました。');
      }).catch(() => {
        alert('コピーに失敗しました。ブラウザの制限がある可能性があります。');
      });
    });

    document.getElementById('printReportBtn').addEventListener('click', () => {
      window.print();
    });

    drawImageAndMarkers();
    setStatus();
    renderDefectList();
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js');
      });
    }
  </script>

</body>
</html>